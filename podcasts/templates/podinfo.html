{% extends 'index/index.html' %}

{% block content %}
<div class="row podinfo" id="podinfo">
  <div class="col-sm-3">
    <img src="{{ podcast.artworkUrl }}170x170bb.jpg" />
  </div>
  <div class="col-sm-6">
    <h3>{{ podcast.title }}</h3>
    <p>{{ podcast.description }}</p>
  </div>
  <div class="col-sm-3">
    <!-- back button refresh this somehow -->
    {% if podcast.subscribed %}
    <form class="sub-form" action="{% url 'subscribe' %}" id="sub-form" method="POST">
      <input type="submit" class="btn btn-dark" id="sub-button" value="Unsubscribe">
      {% csrf_token %}
    </form>
    {% else %}
    <form class="sub-form" action="{% url 'subscribe' %}" id="sub-form" method="POST">
      <input type="submit" class="btn btn-dark" id="sub-button" value="Subscribe">
      {% csrf_token %}
    </form>
    {% endif %}
    <p>{% if podcast.genre.supa %}{{ podcast.genre.supa }} - {% endif %}{{ podcast.genre }}</p>
    <p>{{ podcast.language }}</p>
    {% if podcast.explicit %}
      <p>Explicit</p>
    {% endif %}
    <p><em>{{ podcast.copyrighttext }}</em></p>
  </div>
</div>

<div class="row tracks" id="tracks">
{% include 'tracks.html' %}
</div>

<script type="text/javascript">
$(function() {
  // TODO check if subscribed or nah
  var itunesid = "{{ podcast.itunesid }}";
  var csrftoken = "{{ csrf_token }}";
  // subscription button
  $("#sub-form").submit(function(event) {
    // Stop form from submitting normally
    event.preventDefault();
    var button = $("#sub-button");
    var url = "{% url 'subscribe' %}";
    $.ajax({
      method: "POST",
      url: url,
      data: {
        "itunesid": itunesid,
        "csrfmiddlewaretoken": csrftoken,
      },
      error: function(xhr, ajaxOptions, thrownError){
        console.log(thrownError);
      },
      success: function(data) {
        button.val(data);
      }
    });
  });
  // load tracks for podcast after page is loaded
  $.ajax({
    method: "POST",
    url: "{% url 'tracks' %}",
    data: {
      "itunesid": itunesid,
      "csrfmiddlewaretoken": csrftoken,
    },
    error: function(xhr, ajaxOptions, thrownError){
      console.log(thrownError);
    },
    success: function(response) {
      $("#tracks").hide();
      $("#tracks").html(response);
      $("#tracks").fadeIn();
    }
  });
});
</script>
{% endblock %}
